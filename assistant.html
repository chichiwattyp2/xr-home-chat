<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>XR Labs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Asimovian&display=swap" rel="stylesheet">

  <script src="js/openai-client.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-controller-cursor-component@0.2.7/dist/aframe-controller-cursor-component.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.1/dist/aframe-event-set-component.min.js"></script>
  <script src="js/assistant.js" defer></script>
  <script src="js/travel-node-component.js"></script>
  <script src="js/nav.js"></script>

  <style>
    html, body {margin:0; height:100%;}
    .ui {position:fixed; inset:0; pointer-events:none; font-family: system-ui, -apple-system, Segoe UI, Roboto, "DM Sans", Arial, sans-serif; z-index: 9999;}
    .topbar {position:absolute; left:0; right:0; top:0; height:56px; display:flex; align-items:center; gap:10px; padding:0 12px; color:#fff; pointer-events:auto;}
    .topbar .glass {backdrop-filter: blur(8px); background: rgba(0,0,0,.35); border-bottom:1px solid rgba(255,255,255,.08);}
    .brand {display:flex; align-items:center; gap:10px; font-weight:700}
    .brand .logo {width:28px; height:28px; border-radius:6px; background:#000; display:inline-flex; align-items:center; justify-content:center; color:#0bd3ff; font-weight:800}
    .spacer {flex:1}
    .btn {appearance:none; border:1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.5); color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; pointer-events:auto}
    .panel {position:absolute; right:12px; top:68px; width:360px; max-height:70vh; overflow:auto; background: rgba(10,10,10,.9); border:1px solid rgba(255,255,255,.12); border-radius:16px; color:#eee; padding:12px; display:none; box-shadow: 0 10px 30px rgba(0,0,0,.4); pointer-events:auto}
    .panel.open {display:block}
    .item {display:flex; gap:10px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); margin-bottom:10px; align-items:center}
    .item img {width:56px; height:56px; object-fit:cover; border-radius:8px}
    .muted {opacity:.8; font-size:12px}
    .row {display:flex; align-items:center; justify-content:space-between; gap:8px}
    .hint {position:absolute; left:12px; bottom:12px; background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.1); color:#ddd; padding:8px 10px; border-radius:10px; font-size:13px}
  </style>
</head>

<body>

  <!-- 2D UI overlay -->
  <div class="ui">
    <div class="topbar glass">
      <div class="brand"><div class="logo">i</div> XR Labs <span style="font-size:11px; opacity:.8; margin-left:6px">Metaverse</span></div>
      <div class="spacer"></div>
      <button class="btn" id="btnCatalog">Catalog</button>
      <button class="btn" id="btnCart">Cart (<span id="cartCount">0</span>)</button>
      <button class="btn" id="btnVR">Enter VR</button>
    </div>

    <div id="catalog" class="panel"></div>
    <div id="cart" class="panel"></div>
    <div class="hint">Desktop: WASD + mouse Â· VR: point + trigger</div>
  </div>

  <a-scene antialias="true" vr-mode-ui="enabled: true" loading-screen="backgroundColor: #212121">

    <a-entity id="camera" camera position="0 1.6 1" look-controls>
      <a-cursor rayOrigin="mouse"
                raycaster="objects: .clickable"
                material="color: white"></a-cursor>
    </a-entity>

    <a-assets>
      <a-asset-item id="roboto" src="https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-asset-item>
      <a-asset-item id="assistant-gltf" src="assets/character.glb"></a-asset-item>
      <img id="dawn" crossorigin="anonymous" src="https://cdn.glitch.com/9f5d1b92-a581-4134-8864-9bd98ff8ed97%2Fdawn.jpeg" />
    </a-assets>

    <!-- ðŸ›’ Dispensary shelves -->
    <a-entity id="store" scale="0.5 0.5 0.5" position="0 0 -2.5" store-builder></a-entity>

    <!-- Assistant -->
    <a-entity id="ai" position="0 0 1.3">
      <a-entity class="clickable" gltf-model="assets/character.glb"
        animation-mixer="clip: Idle" position="0 0 -3"></a-entity>
    </a-entity>

    <!-- Renamed 3D catalog container -->
    <a-entity id="catalog3d" scale=".2 .2 .2" position="0 1.1 -1.05">
      <a-entity class="container" id="container" position="-3.15 4 0"></a-entity>
    </a-entity>

    <!-- Teleport pads -->
    <a-entity id="teleport">
      <a-cylinder class="clickable teleport" radius="0.8" height="0.1" position="0 0 -4" color="#141414"></a-cylinder>
      <a-cylinder class="clickable teleport" radius="0.8" height="0.1" position="3 0 -2" color="#141414"></a-cylinder>
      <a-cylinder class="clickable teleport" radius="0.8" height="0.1" position="-3 0 -2" color="#141414"></a-cylinder>
    </a-entity>

    <a-sky src="#dawn"></a-sky>
    <a-entity light="color: #EEE; intensity: 0.5" position="0 5 0"></a-entity>
  </a-scene>

  <!-- Products + Store logic -->
  <script>
  const PRODUCTS_ENDPOINT = '/assets/products.json?v=' + Date.now();
  let PRODUCTS = [];
  const FALLBACK_PRODUCTS = [
    { id:'demo1', name:'Sample A', price:100, category:'Demo', strength:'', img:'', glb:'' }
  ];

  async function loadProducts() {
    try {
      const res = await fetch(PRODUCTS_ENDPOINT, { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      PRODUCTS = Array.isArray(data) ? data : [];
    } catch(e) {
      console.warn('Products fetch failed, fallback.', e);
      PRODUCTS = FALLBACK_PRODUCTS;
    }
  }

  let CART = [];
  const catalogEl = document.getElementById('catalog');
  const cartEl = document.getElementById('cart');
  const cartCount = document.getElementById('cartCount');

  function renderCatalog(){
    catalogEl.innerHTML = '<h3>Catalog</h3>' + PRODUCTS.map(p=>`
      <div class="item">
        <img src="${p.img}" alt="${p.name}"/>
        <div style="flex:1">
          <div style="font-weight:600">${p.name}</div>
          <div class="muted">${p.category} ${p.strength||''}</div>
        </div>
        <div class="row">
          <div style="font-weight:700">R ${p.price}</div>
          <button class="btn" data-id="${p.id}">View</button>
        </div>
      </div>`).join('');
    catalogEl.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const p = PRODUCTS.find(x=>x.id===btn.dataset.id);
        if(p) openProduct(p);
      });
    });
  }
  function renderCart(){
    const total = CART.reduce((s,i)=> s+i.price*i.qty,0);
    cartEl.innerHTML = '<h3>Your Cart</h3>' + (CART.length? CART.map(i=>`
      <div class="item">
        <img src="${i.img}"/>
        <div style="flex:1">${i.name} (x${i.qty})</div>
        <div>R ${i.price*i.qty}</div>
      </div>`).join(''):'<div class="muted">Empty</div>')+
      `<div class="row"><b>Total</b><b>R ${total}</b></div>`;
    cartCount.textContent = CART.reduce((s,i)=>s+i.qty,0);
  }
  function addToCart(p){const ex=CART.find(i=>i.id===p.id); if(ex)ex.qty++; else CART.push({...p,qty:1}); renderCart();}
  function openProduct(p){ if(confirm(`${p.name}\nPrice: R ${p.price}\n\nAdd to cart?`)) addToCart(p); }

  document.getElementById('btnCatalog').onclick=()=>catalogEl.classList.toggle('open');
  document.getElementById('btnCart').onclick=()=>cartEl.classList.toggle('open');
  document.getElementById('btnVR').onclick=()=>document.querySelector('a-scene').enterVR();

  // Shelf + product components
  AFRAME.registerComponent('shelf',{schema:{rows:{type:'int',default:3},cols:{type:'int',default:6}},init(){
    for(let r=0;r<this.data.rows;r++){
      const plank=document.createElement('a-box');
      plank.setAttribute('width',5.4);
      plank.setAttribute('height',0.08);
      plank.setAttribute('depth',0.6);
      plank.setAttribute('color','#2a2a2a');
      plank.setAttribute('position',`0 ${0.6+r*0.8} 0`);
      this.el.appendChild(plank);
    }
    const high=this.data.rows*0.8+0.6;
    [-2.7,2.7].forEach(x=>{
      const up=document.createElement('a-box');
      up.setAttribute('width',0.08);
      up.setAttribute('height',high);
      up.setAttribute('depth',0.6);
      up.setAttribute('color','#2a2a2a');
      up.setAttribute('position',`${x} ${high/2} 0`);
      this.el.appendChild(up);
    });
  }});

  AFRAME.registerComponent('product-box',{schema:{id:{type:'string'}},init(){
    const data=PRODUCTS.find(x=>x.id===this.data.id);
    if(!data)return;
    const box=document.createElement('a-box');
    box.setAttribute('width',0.22);
    box.setAttribute('height',0.32);
    box.setAttribute('depth',0.12);
    box.setAttribute('color','#3aa0ff');
    this.el.appendChild(box);
    const label=document.createElement('a-text');
    label.setAttribute('value',`${data.name}\nR ${data.price}`);
    label.setAttribute('align','center');
    label.setAttribute('width',1.2);
    label.setAttribute('color','#fff');
    label.setAttribute('position','0 0.35 0');
    this.el.appendChild(label);
    this.el.classList.add('clickable');
    this.el.dataset.pid=data.id;
  }});

  AFRAME.registerComponent('store-builder',{
    buildOnce(){if(this._built)return;this._built=true;[-6,0,6].forEach(x=>{
      const shelf=document.createElement('a-entity');
      shelf.setAttribute('position',`${x} 0 0`);
      shelf.setAttribute('shelf','rows:3; cols:6');
      this.el.appendChild(shelf);
    });},
    clearProducts(){this.el.querySelectorAll('[product-box]').forEach(n=>n.remove());},
    populate(){
      this.clearProducts();
      const shelves=this.el.querySelectorAll('[shelf]');
      if(!shelves.length)this.buildOnce();
      const list=(PRODUCTS.length?PRODUCTS:[{id:'placeholder',name:'Sample',price:0}]);
      let idx=0;
      shelves.forEach(shelf=>{
        for(let i=0;i<12&&idx<list.length;i++){
          const p=list[idx++];
          const prod=document.createElement('a-entity');
          prod.setAttribute('product-box',`id:${p.id}`);
          const col=i%6; const row=Math.floor(i/6);
          prod.setAttribute('position',`${-2.2+col*0.88} ${0.7+row*0.8} 0`);
          shelf.appendChild(prod);
        }
      });
    },
    rebuild(){this.buildOnce();this.populate();},
    init(){
      this.buildOnce();this.populate();
      this.el.sceneEl.addEventListener('click',evt=>{
        const t=evt.detail?.intersectedEl||evt.target;
        const pid=t?.dataset?.pid||t?.parentEl?.dataset?.pid;
        if(!pid)return;
        const p=PRODUCTS.find(x=>x.id===pid);
        if(p)openProduct(p);
      });
    }
  });

  // Ensure products load before building store
  (async()=>{
    await loadProducts();
    renderCatalog(); renderCart();
    const storeEl=document.getElementById('store');
    const comp=storeEl.components['store-builder'];
    if(comp)comp.rebuild();
    else storeEl.addEventListener('componentinitialized',e=>{
      if(e.detail.name==='store-builder')storeEl.components['store-builder'].rebuild();
    },{once:true});
  })();
  </script>

</body>
</html>
