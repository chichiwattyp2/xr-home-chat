<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>XR Labs</title>
  <!-- Google Fonts: Asimovian -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Keep only Asimovian loaded to guarantee it’s ready for canvases -->
  <link href="https://fonts.googleapis.com/css2?family=Asimovian&display=swap" rel="stylesheet">

  <script src="js/openai-client.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-controller-cursor-component@0.2.7/dist/aframe-controller-cursor-component.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.1/dist/aframe-event-set-component.min.js"></script>
  <script src="js/assistant.js" defer></script>
  <script src="js/travel-node-component.js"></script>
  <script src="js/nav.js"></script>

  <script>
    function encodeHtml(str) {
      const buf = [];
      for (let i = str.length - 1; i >= 0; i--) buf.unshift(["&#", str[i].charCodeAt(), ";"].join(""));
      return buf.join("");
    }
    const isImageUrl = (u) => /\.(png|jpe?g|gif|webp)(\?.*)?$/i.test(u);

    $(function () {
      const SHEET_ID = "1fy-ZztZlhwgfz1wH8YGji2zuiiEfV88XyCRBDzLB1AA";
      const GID = 9;
      const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

      $.get(gvizUrl, function (text) {
        const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf(")")));
        const rows = json.table.rows || [];
        const listings = [];

        for (let r = 1; r < rows.length; r++) {
          const cells = rows[r].c || [];
          const title = cells[0]?.v ?? "";
          const image = String(cells[1]?.v ?? "");
          const link = String(cells[2]?.v ?? "");

          if ((title || image || link) && isImageUrl(image)) {
            listings.push({
              title: encodeHtml(String(title)),
              image,
              link
            });
          }
        }

        let r = 0, i = 0, p = 0, h = 0, pages = 0;
        for (const listing of listings) {
          const x = i * 2;       // cleaner numeric position
          const y = r * 1.3;
          $("#container").append(`
          <a-image crossorigin="anonymous" position="${x} ${y} 0"
                   width="2" height="1"
                   link="href: ${listing.link}"
                   src="${listing.image}"
                   event-set__enter="_event: mouseenter; _target: #highlight-${h}; visible: true"
                   event-set__leave="_event: mouseleave; _target: #highlight-${h}; visible: false">
            <a-entity geometry="primitive: plane; width: 2; height: .2"
                      material="color: #111"
                      text="align:center; value: ${listing.title}"
                      position="0 -.6 0"></a-entity>
            <a-plane id="highlight-${h}" width="2.05" height="1.25"
                     material="shader: flat; color: white;"
                     position="0 -0.1 -0.01" visible="false"></a-plane>
          </a-image>
        `);

          i++; h++;
          if (i === 4) { r--; i = 0; p++; }
          if (p === 3) { r += 20; p = 0; pages++; console.log(pages); }
        }
      });
    });
  </script>

  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
    integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css"
  />

  <style>
    html, body {margin:0; height:100%;}
    .ui {position:fixed; inset:0; pointer-events:none; font-family: system-ui, -apple-system, Segoe UI, Roboto, "DM Sans", Arial, sans-serif; z-index: 9999;}
    .topbar {position:absolute; left:0; right:0; top:0; height:56px; display:flex; align-items:center; gap:10px; padding:0 12px; color:#fff; pointer-events:auto;}
    .topbar .glass {backdrop-filter: blur(8px); background: rgba(0,0,0,.35); border-bottom:1px solid rgba(255,255,255,.08);}
    .brand {display:flex; align-items:center; gap:10px; font-weight:700}
    .brand .logo {width:28px; height:28px; border-radius:6px; background:#000; display:inline-flex; align-items:center; justify-content:center; color:#0bd3ff; font-weight:800}
    .spacer {flex:1}
    .btn {appearance:none; border:1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.5); color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; pointer-events:auto}
    .panel {position:absolute; right:12px; top:68px; width:360px; max-height:70vh; overflow:auto; background: rgba(10,10,10,.9); border:1px solid rgba(255,255,255,.12); border-radius:16px; color:#eee; padding:12px; display:none; box-shadow: 0 10px 30px rgba(0,0,0,.4); pointer-events:auto}
    .panel.open {display:block}
    .item {display:flex; gap:10px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); margin-bottom:10px; align-items:center}
    .item img {width:56px; height:56px; object-fit:cover; border-radius:8px}
    .muted {opacity:.8; font-size:12px}
    .row {display:flex; align-items:center; justify-content:space-between; gap:8px}
    .hint {position:absolute; left:12px; bottom:12px; background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.1); color:#ddd; padding:8px 10px; border-radius:10px; font-size:13px}
    .video {
      max-width: calc(50% - 100px);
      margin: 0 50px;
      box-sizing: border-box;
      border-radius: 2px;
      padding: 0;
      box-shadow:
        rgba(156, 172, 172, 0.2) 0px 2px 2px,
        rgba(156, 172, 172, 0.2) 0px 4px 4px,
        rgba(156, 172, 172, 0.2) 0px 8px 8px,
        rgba(156, 172, 172, 0.2) 0px 16px 16px,
        rgba(156, 172, 172, 0.2) 0px 32px 32px,
        rgba(156, 172, 172, 0.2) 0px 64px 64px;
    }
  </style>
</head>

<body>

  <!-- 2D UI overlay -->
  <div class="ui">
    <div class="topbar glass">
      <div class="brand"><div class="logo">i</div> XR Labs <span style="font-size:11px; opacity:.8; margin-left:6px">Metaverse</span></div>
      <div class="spacer"></div>
      <button class="btn" id="btnCatalog">Catalog</button>
      <button class="btn" id="btnCart">Cart (<span id="cartCount">0</span>)</button>
      <button class="btn" id="btnVR">Enter VR</button>
    </div>

    <div id="catalog" class="panel"></div>
    <div id="cart" class="panel"></div>
    <div class="hint">Desktop: WASD + mouse to look · Click products to view · VR: use controller to point + trigger</div>
  </div>

  <a-scene antialias="true" vr-mode-ui="enabled: true" loading-screen="backgroundColor: #212121" physics>

    <a-entity id="camera"
      camera
      position="0 1.6 1.09195"
      look-controls>
      <a-cursor rayOrigin="mouse"
                raycaster="objects: .clickable"
                material="color: white"></a-cursor>
    </a-entity>

    <a-assets>
      <!-- MSDF font for labels -->
      <a-asset-item id="roboto" src="https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-asset-item>

      <a-asset-item id="assistant-gltf" src="assets/character.glb"></a-asset-item>

      <audio id="piano_c" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fnote%20c%20piano.mp3?v=1565881186559" crossorigin="anonymous"></audio>
      <audio id="piano_d" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20d.mp3?v=1565883564721" crossorigin="anonymous"></audio>
      <audio id="piano_e" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20e.mp3?v=1565883566923" crossorigin="anonymous"></audio>
      <audio id="piano_f" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20f.mp3?v=1565883568318" crossorigin="anonymous"></audio>
      <audio id="piano_g" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20g.mp3?v=1565883569859" crossorigin="anonymous"></audio>
      <audio id="piano_a" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20a.mp3?v=1565883562372" crossorigin="anonymous"></audio>
      <audio id="piano_b" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20b.mp3?v=1565883563277" crossorigin="anonymous"></audio>
      <audio id="piano_hc" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fhigh%20c%20piano.mp3?v=1565889882364" crossorigin="anonymous"></audio>
      <audio id="piano_csharp" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fc%20sharp.mp3?v=1565890996511" crossorigin="anonymous"></audio>
      <audio id="piano_eflat" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fe%20flat.mp3?v=1565890997434" crossorigin="anonymous"></audio>
      <audio id="piano_fsharp" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Ff%20sharp.mp3?v=1565890998603" crossorigin="anonymous"></audio>
      <audio id="piano_gsharp" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fg%20sharp.mp3?v=1565890999944" crossorigin="anonymous"></audio>
      <audio id="piano_bflat" src="https://cdn.glitch.com/f787028e-c9fe-4c7e-be02-7c6f07bca314%2Fpiano%20b%20flat.mp3?v=1565891011666" crossorigin="anonymous"></audio>

      <!-- Mixins & assets -->
      <a-mixin id="black" material="color:#000000"></a-mixin>
      <a-mixin id="white" material="color:#e6e6e6"></a-mixin>
      <a-mixin id="bar" geometry="primitive: box" material="color: rgb(10, 20, 50); shader: flat" scale-y-color="from: 10 20 50; to: 210, 220, 250; maxScale: 15"></a-mixin>

      <a-asset-item id="adidas" src="https://cdn.glitch.com/80103382-77c7-436e-ac28-b71dc8e4468c%2Fgazelle.glb"></a-asset-item>
      <a-asset-item id="newbalance" src="https://cdn.glitch.com/b2a38be5-8f68-46a7-9578-fcbaeb96f8a1%2Fnb.glb"></a-asset-item>
      <a-asset-item id="vizor-obj" src="https://cdn.glitch.com/95b833fa-57f9-4d7f-8d26-094de79b4d3a%2Fvizor.obj"></a-asset-item>
      <a-asset-item id="frame-obj" src="https://cdn.glitch.com/95b833fa-57f9-4d7f-8d26-094de79b4d3a%2Fframe.obj"></a-asset-item>
      <a-asset-item id="helmet-obj" src="https://cdn.glitch.com/95b833fa-57f9-4d7f-8d26-094de79b4d3a%2Fhelmet.obj"></a-asset-item>
      <a-asset-item id="suit-obj" src="https://cdn.glitch.com/95b833fa-57f9-4d7f-8d26-094de79b4d3a%2Fsuit.obj"></a-asset-item>

      <img id="dawn" crossorigin="anonymous" src="https://cdn.glitch.com/9f5d1b92-a581-4134-8864-9bd98ff8ed97%2Fdawn.jpeg" />

      <a-mixin id="board" geometry="depth: .05; height: 1; width: 6" material="shader: flat" pivot="0 0.5 0" position="0 -1 0"></a-mixin>
      <a-mixin id="unhinge" attribute="rotation" to="0 0 0" dur="1000" fill="both"></a-mixin>
      <a-mixin id="checkpoint"></a-mixin>
      <a-mixin id="checkpoint-hovered" color="#141414"></a-mixin>

      <video id="1" autoplay loop="true" src="assets/1.mp4"></video>
      <video id="2" autoplay loop="true" src="assets/2.mp4"></video>
      <video id="3" autoplay loop="true" src="assets/3.mp4"></video>
      <video id="4" autoplay loop="true" src="assets/4.mp4"></video>
      <video id="5" autoplay loop="true" src="assets/5.mp4"></video>

      <a-asset-item id="picframe.obj" src="assets/picframe.obj" preload="auto"></a-asset-item>
      <a-asset-item id="las_vegas_obj" src="assets/Las_Vegas.obj" preload="auto"></a-asset-item>
      <img id="las_vegas_diffuse" src="assets/Las_vegas_Diffuse_01.jpg" crossorigin="anonymous" preload="auto"/>
      <img id="las_vegas_normal" src="assets/Las_vegas_Normal_01.jpg" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="damas_pillier_obj" src="assets/Damas.obj" preload="auto"></a-asset-item>
      <img id="Damas_Pillier_diffuse" src="assets/Damas_02_diffuse_03.jpg" crossorigin="anonymous" preload="auto"/>
      <a-asset-item id="damas_sortie_obj" src="assets/panneau_sortie.obj" preload="auto"></a-asset-item>
      <a-asset-item id="damas_station_obj" src="assets/panneau_station.obj" preload="auto"></a-asset-item>
      <img id="Damas_panneaux_diffuse" src="assets/Panneau_metro_Diffuse.jpg" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="bust" src="assets/Statue.glb" preload="auto"></a-asset-item>
      <a-asset-item id="console" src="assets/walnut.glb" preload="auto"></a-asset-item>

      <a-asset-item id="lamp_obj" src="assets/Lamp.obj" preload="auto"></a-asset-item>
      <img id="lamp_diffuse" src="assets/echelle_diffuse_01.jpg" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="cimaise_billet_obj" src="assets/Cimese_Echelle_Billet_01.obj" preload="auto"></a-asset-item>
      <img id="cimaise_billet_diffuse" src="assets/Cimese_Echelle_Billet_Diffuse_02.jpg" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="cimaise_poster_obj" src="assets/Cimaise_02.obj" preload="auto"></a-asset-item>
      <img id="cimaise_posters_diffuse" src="assets/Cimaise_02_Diffuse_05_4096.jpg" crossorigin="anonymous" preload="auto"/>

      <img id="pic1" src="assets/pic1.jpg" crossorigin="anonymous" preload="auto"/>
      <img id="pic2" src="assets/pic2.jpg" crossorigin="anonymous" preload="auto"/>
      <img id="floor" src="assets/floor2.png" crossorigin="anonymous" preload="auto"/>
      <img id="pic3" src="assets/pic3.jpg" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="toit_obj" src="assets/Toit_01.obj" preload="auto"></a-asset-item>
      <img id="toit_diffuse" src="assets/ToitOcclusion_ambiante.jpg" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="mur_obj" src="assets/Mur_Scene_03.obj" preload="auto"></a-asset-item>
      <img id="mur_diffuse" src="assets/5-Mur_Diffuse_01_15.jpg" crossorigin="anonymous" preload="auto"/>

      <img id="vidcards" src="assets/cards-01.png" crossorigin="anonymous" preload="auto"/>

      <a-asset-item id="sol_obj" src="assets/Sol.obj" preload="auto"></a-asset-item>
      <img id="sol_diffuse" src="assets/Sol_diffuse_08.jpg" crossorigin="anonymous" preload="auto"/>

      <a-mixin id="all-interactions"
               hoverable grabbable stretchable draggable
               event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
